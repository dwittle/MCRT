{% extends "base.html" %}

{% block title %}Dashboard - Media Review Tool{% endblock %}

{% block content %}
<h2>Collection Overview</h2>

{% if error_message %}
<div class="error-box">
    <h3>⚠️ CLI Connection Issue</h3>
    <p>The dashboard is running with fallback data because the CLI interface encountered an error:</p>
    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">{{ error_message }}</pre>
    
    <div style="margin-top: 16px;">
        <a href="/debug/info" class="btn btn-secondary">🔧 View Debug Info</a>
        <a href="/health" class="btn btn-secondary">🏥 Health Check</a>
        <button class="btn btn-secondary" onclick="location.reload()">🔄 Retry</button>
    </div>
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="number">{{ "{:,}".format(stats.counts.files) if stats.counts and stats.counts.files else "0" }}</div>
        <div class="label">Total Files</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ "{:,}".format(stats.counts.groups) if stats.counts and stats.counts.groups else "0" }}</div>
        <div class="label">Groups</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ "{:,}".format(stats.review_status.keep) if stats.review_status and stats.review_status.keep else "0" }}</div>
        <div class="label">✅ Marked Keep</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ "{:,}".format(stats.review_status.not_needed) if stats.review_status and stats.review_status.not_needed else "0" }}</div>
        <div class="label">❌ Not Needed</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ "{:,}".format(stats.review_status.undecided) if stats.review_status and stats.review_status.undecided else "0" }}</div>
        <div class="label">⏳ Need Review</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ "{:.1f} GB".format((stats.storage.total_bytes or 0) / (1024**3)) if stats.storage and stats.storage.total_bytes else "0.0 GB" }}</div>
        <div class="label">Total Size</div>
    </div>
</div>

{% if not error_message %}
<h3>Review Workflow</h3>
<div class="actions">
    <a href="{{ url_for('view_groups', status='undecided') }}" class="btn btn-primary">
        📂 Review Duplicate Groups
        {% set multi_file_count = 0 %}
        {% if stats.counts and stats.counts.groups %}
            {% set multi_file_count = stats.counts.groups %}
        {% endif %}
        {% if multi_file_count > 0 %}
        <span class="badge">{{ multi_file_count }}</span>
        {% endif %}
    </a>
    <a href="{{ url_for('view_singles', status='undecided') }}" class="btn btn-secondary">
        🖼️ Review Individual Images
        {% set singles_count = 0 %}
        {% if stats.review_status and stats.review_status.undecided %}
            {% set singles_count = stats.review_status.undecided %}
        {% endif %}
        {% if singles_count > 0 %}
        <span class="badge">{{ singles_count }}</span>
        {% endif %}
    </a>
    <a href="{{ url_for('bulk_actions') }}" class="btn btn-secondary">
        ⚡ Bulk Actions
    </a>
    <a href="{{ url_for('export_page') }}" class="btn btn-secondary">
        📥 Export Results
    </a>
</div>

{% if stats.review_status and stats.review_status.undecided and stats.review_status.undecided > 0 %}
<div class="info-box">
    <h4>📊 Review Progress</h4>
    <div class="progress-info">
        <div>✅ Reviewed: {{ "{:,}".format((stats.review_status.keep or 0) + (stats.review_status.not_needed or 0)) }} files</div>
        <div>⏳ Remaining: {{ "{:,}".format(stats.review_status.undecided or 0) }} files</div>
    </div>

    {% set total_files = stats.counts.files if stats.counts and stats.counts.files else 0 %}
    {% if total_files > 0 %}
    {% set progress = ((stats.review_status.keep or 0) + (stats.review_status.not_needed or 0)) / total_files * 100 %}
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ progress }}%"></div>
    </div>
    <div class="progress-text">
        {{ "%.1f"|format(progress) }}% complete
    </div>
    {% else %}
    <div class="progress-bar">
        <div class="progress-fill" style="width: 0%"></div>
    </div>
    <div class="progress-text">0.0% complete</div>
    {% endif %}
</div>
{% endif %}

{% set file_count = stats.counts.files if stats.counts and stats.counts.files else 0 %}
{% if file_count > 0 %}
<div class="info-box">
    <h4>📸 Collection Details</h4>
    <div class="detail-grid">
        <div>
            <strong>File Types:</strong><br>
            {% set images = stats.storage.total_files or 0 %}
            {% set videos = 0 %}
            {{ "{:,}".format(images) }} images, {{ "{:,}".format(videos) }} videos
        </div>
        <div>
            <strong>Storage:</strong><br>
            {% set total_gb = (stats.storage.total_bytes or 0) / (1024**3) %}
            {% set avg_mb = (stats.storage.avg_bytes or 0) / (1024**2) %}
            {{ "{:.1f} GB".format(total_gb) }} total ({{ "{:.1f} MB".format(avg_mb) }} avg)
        </div>
        <div>
            <strong>Groups:</strong><br>
            {% set total_groups = stats.counts.groups or 0 %}
            {% set single_files = (stats.counts.files or 0) - total_groups %}
            {{ "{:,}".format(total_groups) }} with duplicates, {{ "{:,}".format(single_files) }} unique
        </div>
        <div>
            <strong>Large Files:</strong><br>
            {{ "{:,}".format(stats.storage.large_files or 0) }} over {{ "{:.0f} MB".format((stats.storage.large_threshold_bytes or 0) / (1024**2)) }}
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- Error mode - show troubleshooting -->
<div class="info-box">
    <h4>🔧 Troubleshooting</h4>
    <p>To resolve the CLI connection issue, try these steps:</p>
    
    <ol style="margin-left: 20px; line-height: 1.6;">
        <li><strong>Check that the CLI script exists:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">ls -la media_tool_cli.py</pre>
        </li>
        
        <li><strong>Make sure it's executable:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">chmod +x media_tool_cli.py</pre>
        </li>
        
        <li><strong>Test the CLI directly:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">./media_tool_cli.py --help</pre>
        </li>
        
        <li><strong>Check if you have a database:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">ls -la media_index.db</pre>
        </li>
        
        <li><strong>If no database exists, run a scan first:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">./media_tool_cli.py scan --source /path/to/photos --central ./data</pre>
        </li>
        
        <li><strong>Check Python dependencies:</strong>
            <pre style="background: #f0f0f0; padding: 8px; margin: 8px 0;">pip install -r requirements.txt</pre>
        </li>
    </ol>
    
    <div style="margin-top: 16px;">
        <a href="/debug/info" class="btn btn-primary">🔧 View Debug Information</a>
        <a href="/health" class="btn btn-secondary">🏥 System Health Check</a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
// Auto-refresh stats every 30 seconds if reviewing
{% if stats.review_status and stats.review_status.undecided and stats.review_status.undecided > 0 and not error_message %}
setInterval(() => {
    fetch('/api/stats?detailed=true')
        .then(response => response.json())
        .then(data => {
            if (data.data && data.data.review_status && data.data.review_status.undecided !== {{ stats.review_status.undecided }}) {
                // Stats changed, refresh page
                location.reload();
            }
        })
        .catch(error => console.log('Stats refresh error:', error));
}, 30000);
{% endif %}

// Debug mode indicator
{% if error_message %}
console.log('Dashboard running in fallback mode due to CLI error');
console.log('Visit /debug/info for detailed debugging information');
{% endif %}
</script>
{% endblock %}